<@row>
    <@columns>
        <@box color='primary'>
            <@boxHeader title='#i18n{elasticdata.manage_elasticdata.title}' boxTools=true>
            </@boxHeader>
            <@boxBody>
                <@table>
                    <tr>
                        <th>#i18n{elasticdata.manage_elasticdata.columnDataSource}</th>
                        <th>#i18n{elasticdata.manage_elasticdata.columnActions}</th>
                    </tr>
                    <#list data_sources_list as source>
                        <tr>
                            <td>${source.name}
                                <div class="progress" id="${source.id}" style="display:none">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated"
                                        role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                    </div>
                                </div>
                                <div id="log-${source.id}">
                                </div>
                            </td>
                            <td>
                                <@button title='#i18n{elasticdata.manage_elasticdata.buttonIndex}' buttonIcon='cogs'
                                    color="primary" params='data-indexId="${source.id}" check=true' id='btn-${source.id}' />
                            </td>
                        </tr>
                    </#list>
                </@table>
            </@boxBody>
        </@box>
    </@columns>
</@row>
<@scrollTopBtn />
<script>
    // variables
    const datasources = document.querySelectorAll("*[data-indexId]");
    // check if one of datasources is indexing;
    async function check() {
        if (datasources != null) {
            for (const datasource of datasources) {
                const dataSourceId = datasource.getAttribute('data-indexId');
                 if( datasource.getAttribute('check') === "true" ) {
                     await getStatus(dataSourceId).then(json => {
                	progressBar(dataSourceId, json)
                    });
                }
            }
        }
    }
    // get index status 
    async function getStatus(dataSourceId) {
        let response = await fetch(
            "jsp/admin/plugins/elasticdata/IndexingElasticData.jsp?action=checkIndexStatus&data_source=" +
            dataSourceId);
        let data = await response.json()
        return data;
    }
    // run indexation
    async function runIndex(dataSourceId) {
        let response = await fetch(
            "jsp/admin/plugins/elasticdata/IndexingElasticData.jsp?action=index&data_source=" +
            dataSourceId);
        let data = await response.json()
    }
    // checking
    setInterval(function () {
        check()
    }, 3000);
    // progress bar
    function progressBar(dataSourceId, json) {
        const progressBar = document.getElementById(dataSourceId);
        const btn = document.getElementById("btn-" + dataSourceId);
        if (json !== null) {
            if ( json.isRunning ) {
                document.getElementById("log-"+dataSourceId).innerHTML = "<i>" + json.sbLogs + "</i>"
                progressBar.style.display = 'block';
                progressBar.getElementsByClassName('.progress');
                btn.disabled = true;
                const bar = progressBar.querySelector("*[aria-valuenow]");
                bar.setAttribute("aria-valuenow", json.progress);
                bar.style.width = json.progress + "%";
                bar.innerHTML = json.progress.toFixed(2) + "%" + " (" + json.currentNbIndexedObj + "/" + json.nbTotalObj + ")";
            } else {
               btn.setAttribute("check",false)
               progressBar.style.display = 'none';
               btn.disabled = false;
            };
        }
    }

    // register btn listeners
    for (datasource of datasources) {
        datasource.addEventListener('click', async function (event) {
            event.preventDefault();
            const dataSourceId = event.target.getAttribute('data-indexId');
            event.target.disabled = true;
            const progressBar = document.getElementById(dataSourceId);
            runIndex(dataSourceId);
            event.target.setAttribute("check",true);
        }, false);
    }
</script>
<style>
    table .progress,
    table .progress-bar {
        height: 20px !important;
        font-weight: bold;
        text-transform: uppercase;
    }
</style>