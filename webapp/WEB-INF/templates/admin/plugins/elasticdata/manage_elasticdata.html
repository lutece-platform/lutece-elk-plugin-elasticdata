<@row>
    <@columns>
        <@box color='primary'>
            <@boxHeader title='#i18n{elasticdata.manage_elasticdata.title}' boxTools=true>
            </@boxHeader>
            <@boxBody>
                <@table>
                    <tr>
                        <th>#i18n{elasticdata.manage_elasticdata.columnDataSource}</th>
                        <th>#i18n{elasticdata.manage_elasticdata.columnActions}</th>
                    </tr>
                    <#list data_sources_list as source>
                        <tr>
                            <td>${source.name}</td>
                            <td>
                                <a class="btn btn-primary btn-index" data-indexId="${source.id}" href="#">
                                    <span class="fa fa-cogs"></span>
                                    #i18n{elasticdata.manage_elasticdata.buttonIndex}
                                </a>
                            </td>
                        </tr>
                    </#list>
                </@table>
            </@boxBody>
        </@box>
    </@columns>
</@row>
<@scrollTopBtn />
<script>
    $(function () {
        $(".fa-spin").hide();
        var mapIndexingInterval = new Map();
        addIndexingEvent(mapIndexingInterval);
    });

    function addIndexingEvent(mapIndexingInterval) {
        $('.btn-index').click(function (e) {
            e.preventDefault();
            var dataSourceId = $(this).attr("data-indexId");
            $.ajax({
                url: "jsp/admin/plugins/elasticdata/IndexingElasticData.jsp",
                method: "GET",
                data: "action=index&data_source=" + dataSourceId,
                dataType: "json"
            });
            removeExistingProgressBar(dataSourceId);
            var alink = $(this);
            addHtmlProgressBar(dataSourceId, alink);
            var indexStatusInterval = setInterval(function () {
                checkIndexingStatus(dataSourceId, alink, mapIndexingInterval)
            }, 1000);
            mapIndexingInterval.set(dataSourceId, indexStatusInterval);
        });
    }

    function checkIndexingStatus(dataSourceId, aLink, mapIndexingInterval) {
        $.ajax({
            url: "jsp/admin/plugins/elasticdata/IndexingElasticData.jsp",
            method: "GET",
            data: "action=checkIndexStatus&data_source=" + dataSourceId,
            dataType: "json",
            success: function (data, status) {
                percent = data.percent;
                if (percent > 99.9) {
                    percent = 100
                    clearInterval(mapIndexingInterval.get(dataSourceId));
                }
                editHtmlProgressBar(dataSourceId, percent, aLink);
            },
        });
    }

    function addHtmlProgressBar(dataSourceId, aLink) {
        $(aLink).parents("tr").find("td:first-child").append('<div class="progress"><div id="progress-' + dataSourceId +
            '" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" ></div></div>'
            );
    }

    function editHtmlProgressBar(dataSourceId, percent, aLink) {
        if (percent > 99) {
            $(aLink).parents("tr").find(".fa-spin").hide();
            //$(aLink).parents("tr").first().append('<span class="label label-success"><i class="fa fa-check"></i> Complété !</span>');
        }
        if( percent > 0 ) {
        $("#progress-" + dataSourceId).width(percent + "%");
        $("#progress-" + dataSourceId).attr("aria-valuenow", percent);
        $("#progress-" + dataSourceId).text(Math.floor(percent) + "%");
        }
 
    }

    function removeExistingProgressBar(dataSourceId) {
        $("#progress-" + dataSourceId).remove();
    }
</script>
<style>
    table .progress,
    table .progress-bar {
        height: 15px !important;
    }
</style>